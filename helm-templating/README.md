# Exploring Helm Templating

link: https://www.youtube.com/watch?v=-ykwb1d0DXU
goto about 4:50

## setup
```
need minikube running
need helm installed
```

## notes
```
she talks about the use cases for a while
around 8:39 we get to something practical
```

## helm chart structure
```
we have already seen the helm create mychart garbage
(apologies. autogenerated code is just a bad idea)
manual creation looks like

mychart/
    Chart.yaml  # meta information about chart - name version dependencies
    values.yaml # default values for placheolders
    charts/     # dependenices are downloaded here as tgz
    templates/  # actual templates for various kube things

So, when you execute helm install <chartname>
templates are filled with values from value.yaml (or other overrides)
overrides by providing an alternative: helm install --values=my-values.yaml <chartname>
```
## overrides
```
imagine values.yaml has:

imageName: myapp
port: 8080
version: 1.0.0.

and my-values.yaml has:

version: 2.0.0

Results in a .Values object:
imageName: myapp
port: 8080
version: 2.0.0


Note we could have done this with : helm install --set version=2.0.0
```

## more chatter
```
helm 2 has tiller
helm 3 doesn't
We don't care about 2.
```

## OK, so much for the youtube video

### So lets hack.
```
create directory structure - manually:

mkdir mychart
mkdir mychart/charts
mkdir mychart/templates
touch mychart/Chart.yaml
touch mychart/values.yaml
touch mychart/templates/deployment.yaml

We put some defaults into Chart.yaml.

I want to base this on the job_script.yaml we created when learning about
kube jobs. recall:

$ cat job_script.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: helloworld
spec: 
  template:
    spec:
      containers:
      - name: busybox
        image: busybox
        env:
        - name: MESSAGE
          value: "Hello Kerbernetes!!"
        command: ["/bin/sh"]
        args: ["-c", "while true; do echo $(MESSAGE); sleep 10; done"]
      restartPolicy: Never

So, I think the deployment.yaml should look like:
apiVersion: batch/v1
kind: Job
metadata:
  name: helloworld
spec:
  template:
    spec:
      containers:
      - name: busybox
        image: busybox
        env:
        - name: MESSAGE
          value: {{ .Values.data.message }}
        command: ["/bin/sh"]
        args: ["-c", "while true; do echo $(MESSAGE); sleep 10; done"]
      restartPolicy: Never

We can template a LOT more. But for this I want to keep it really simple.

values.yaml
data:
    message: "Hello World"

Ok, lets take it for a spin

$ helm install my-chart mychart/ --values mychart/values.yaml
NAME: my-chart
LAST DEPLOYED: Fri Jun 19 21:09:02 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None

Check the running state:

$ kubectl get all
NAME                   READY   STATUS    RESTARTS   AGE
pod/helloworld-4gj9h   1/1     Running   0          105s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   12d

NAME                   COMPLETIONS   DURATION   AGE
job.batch/helloworld   0/1           105s       105s

Grab the log:

$ kubectl logs pod/helloworld-4gj9h
Hello World
Hello World
Hello World
Hello World
Hello World
Hello World
Hello World
Hello World
Hello World
Hello World
Hello World

NICE. That very simple example worked.

Lets see what we have:

$ helm list
NAME    	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART         	APP VERSION
my-chart	default  	1       	2020-06-19 21:09:02.545894582 -0400 EDT	deployed	my-chart-0.0.1	1.0.0      

Ok, take it down:

$ helm uninstall my-chart
release "my-chart" uninstalled
steve@kube:~/projects/kuber-demos/helm-templating$ helm list
NAME	NAMESPACE	REVISION	UPDATED	STATUS	CHART	APP VERSION
steve@kube:~/projects/kuber-demos/helm-templating$ kubectl get all
NAME                   READY   STATUS        RESTARTS   AGE
pod/helloworld-4gj9h   1/1     Terminating   0          5m47s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   12d

Terminating ... ok, I'll give it 5 mins

$ kubectl get all
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   12d

And we are golden.
```


